{
  "schemaVersion": "0.3",
  "description": "Creates a Windows Managed Instance",
  "assumeRole": "{{AutomationAssumeRole}}",
   "parameters": {
	"AutomationAssumeRole": {
		"type": "String",
		"description": "The ARN of the role that allows Automation to perform the actions on your behalf",
		"default": ""
	},
	"LambdaAssumeRole": {
		"type": "String",
		"description": "The ARN of the role that allows Lambda created by Automation to perform the actions on your behalf",
		"default": "arn:aws:iam::{{global:ACCOUNT_ID}}:role/AutomationLambdaRole"
	},
    "RoleName": {
      "type": "String",
      "description": "(Required) Rolename to create.",
	  "default": "Role-{{automation:EXECUTION_ID}}"
    },
    "GroupName": {
      "type": "String",
      "description": "(Required) Group Name to create.",
	  "default": "Group-{{automation:EXECUTION_ID}}"
    },
    "AmiId": {
      "type": "String",
      "description": "(Required) AMI id to use for launching the instance."
    } ,
    "InstanceType": {
      "type": "String",
      "description": "(Optional) Type of instance to launch. Default is t2.medium.",
      "default": "t2.medium"
    }, 
    "KeyPairName": {
      "type": "String",
      "description": "(Required) Key pair to use when creating instance."
    }    
   },
"mainSteps": [
        {
            "name": "CreateManagedInstanceProfile",	
            "action": "aws:executeAutomation",	
            "maxAttempts": 1,	
            "timeoutSeconds": 300,	
            "onFailure": "Abort",	
            "inputs": {		
                "DocumentName": "awstest-CreateManagedInstanceProfile",	
                "DocumentVersion": "1", 	
                "RuntimeParameters": {			
                    "RoleName": ["{{RoleName}}"]		
                    }	
                }
        },
        {
            "name": "CreateSecurityGroup",	
            "action": "aws:executeAutomation",	
            "maxAttempts": 1,	
            "timeoutSeconds": 300,	
            "onFailure": "Abort",	
            "inputs": {		
                "DocumentName": "awstest-CreateSecurityGroup",	
                "DocumentVersion": "1", 	
                "RuntimeParameters": {			
                    "GroupName": ["{{GroupName}}"],
                    "Platform": ["Linux"]	
                    }	
                }
        },
        {
            "name": "LaunchInstance",
            "action": "aws:runInstances",
            "maxAttempts": 3,
            "timeoutSeconds": 1200,
            "onFailure": "Abort",
            "inputs": {
                "ImageId": "{{AmiId}}",
                "InstanceType": "{{InstanceType}}",
                "MinInstanceCount": 1,
                "MaxInstanceCount": 1,
                "IamInstanceProfileName": "{{RoleName}}",
                "SecurityGroups" :["{{GroupName}}"],
                "KeyName" : "{{KeyPairName}}",
                "UserData" : "IyEvYmluL2Jhc2gNCg0KZnVuY3Rpb24gZ2V0X2NvbnRlbnRzKCkgew0KICAgIGlmIFsgLXggIiQod2hpY2ggY3VybCkiIF07IHRoZW4NCiAgICAgICAgY3VybCAtcyAtZiAiJDEiDQogICAgZWxpZiBbIC14ICIkKHdoaWNoIHdnZXQpIiBdOyB0aGVuDQogICAgICAgIHdnZXQgIiQxIiAtTyAtDQogICAgZWxzZQ0KICAgICAgICBkaWUgIk5vIGRvd25sb2FkIHV0aWxpdHkgKGN1cmwsIHdnZXQpIg0KICAgIGZpDQp9DQoNCnJlYWRvbmx5IElERU5USVRZX1VSTD0iaHR0cDovLzE2OS4yNTQuMTY5LjI1NC8yMDE2LTA2LTMwL2R5bmFtaWMvaW5zdGFuY2UtaWRlbnRpdHkvZG9jdW1lbnQvIg0KcmVhZG9ubHkgVFJVRV9SRUdJT049JChnZXRfY29udGVudHMgIiRJREVOVElUWV9VUkwiIHwgYXdrIC1GXCIgJy9yZWdpb24vIHsgcHJpbnQgJDQgfScpDQpyZWFkb25seSBERUZBVUxUX1JFR0lPTj0idXMtZWFzdC0xIg0KcmVhZG9ubHkgUkVHSU9OPSIke1RSVUVfUkVHSU9OOi0kREVGQVVMVF9SRUdJT059Ig0KDQpyZWFkb25seSBTQ1JJUFRfTkFNRT0iYXdzLWluc3RhbGwtc3NtLWFnZW50Ig0KIFNDUklQVF9VUkw9Imh0dHBzOi8vYXdzLXNzbS1kb3dubG9hZHMtJFJFR0lPTi5zMy5hbWF6b25hd3MuY29tL3NjcmlwdHMvJFNDUklQVF9OQU1FIg0KDQppZiBbICIkUkVHSU9OIiA9ICJjbi1ub3J0aC0xIiBdOyB0aGVuDQogIFNDUklQVF9VUkw9Imh0dHBzOi8vYXdzLXNzbS1kb3dubG9hZHMtJFJFR0lPTi5zMy5jbi1ub3J0aC0xLmFtYXpvbmF3cy5jb20uY24vc2NyaXB0cy8kU0NSSVBUX05BTUUiDQpmaQ0KDQppZiBbICIkUkVHSU9OIiA9ICJ1cy1nb3Ytd2VzdC0xIiBdOyB0aGVuDQogIFNDUklQVF9VUkw9Imh0dHBzOi8vYXdzLXNzbS1kb3dubG9hZHMtJFJFR0lPTi5zMy11cy1nb3Ytd2VzdC0xLmFtYXpvbmF3cy5jb20vc2NyaXB0cy8kU0NSSVBUX05BTUUiDQpmaQ0KDQpjZCAvdG1wDQpGSUxFX1NJWkU9MA0KTUFYX1JFVFJZX0NPVU5UPTMNClJFVFJZX0NPVU5UPTANCg0Kd2hpbGUgWyAkUkVUUllfQ09VTlQgLWx0ICRNQVhfUkVUUllfQ09VTlQgXSA7IGRvDQogIGVjaG8gQVdTLVVwZGF0ZUxpbnV4QW1pOiBEb3dubG9hZGluZyBzY3JpcHQgZnJvbSAkU0NSSVBUX1VSTA0KICBnZXRfY29udGVudHMgIiRTQ1JJUFRfVVJMIiA+ICIkU0NSSVBUX05BTUUiDQogIEZJTEVfU0laRT0kKGR1IC1rIC90bXAvJFNDUklQVF9OQU1FIHwgY3V0IC1mMSkNCiAgZWNobyBBV1MtVXBkYXRlTGludXhBbWk6IEZpbmlzaGVkIGRvd25sb2FkaW5nIHNjcmlwdCwgc2l6ZTogJEZJTEVfU0laRQ0KICBpZiBbICRGSUxFX1NJWkUgLWd0IDAgXTsgdGhlbg0KICAgIGJyZWFrDQogIGVsc2UNCiAgICBpZiBbWyAkUkVUUllfQ09VTlQgLWx0IE1BWF9SRVRSWV9DT1VOVCBdXTsgdGhlbg0KICAgICAgUkVUUllfQ09VTlQ9JCgoUkVUUllfQ09VTlQrMSkpOw0KICAgICAgZWNobyBBV1MtVXBkYXRlTGludXhBbWk6IEZpbGVTaXplIGlzIDAsIHJldHJ5Q291bnQ6ICRSRVRSWV9DT1VOVA0KICAgIGZpDQogIGZpIA0KZG9uZQ0KDQppZiBbICRGSUxFX1NJWkUgLWd0IDAgXTsgdGhlbg0KICBjaG1vZCAreCAiJFNDUklQVF9OQU1FIg0KICBlY2hvIEFXUy1VcGRhdGVMaW51eEFtaTogUnVubmluZyBVcGRhdGVTU01BZ2VudCBzY3JpcHQgbm93IC4uLi4NCiAgLi8iJFNDUklQVF9OQU1FIiAtLXJlZ2lvbiAiJFJFR0lPTiINCmVsc2UNCiAgZWNobyBBV1MtVXBkYXRlTGludXhBbWk6IFVuYWJsZSB0byBkb3dubG9hZCBzY3JpcHQsIHF1aXR0aW5nIC4uLi4NCmZp"
            }
        }
    ]
}